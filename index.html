<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§ä¸­è‹±èªç‰¹è¨“ç­</title>
    <link href="icon.png" rel="shortcut icon">
    <script src="data.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: #f4f7f6; margin: 0; color: #333; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; position: relative;}
        h1 { margin: 0; font-size: 28px; }
        .subtitle { opacity: 0.8; font-size: 14px; margin-top: 5px; }
        
        /* Login & User Info */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-input { width: 80%; padding: 10px; margin: 20px 0; font-size: 18px; border: 2px solid #ddd; border-radius: 5px; }
        .login-btn { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; }
        #user-display { position: absolute; top: 15px; right: 20px; color: white; font-weight: bold; font-size: 14px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);}

        /* Report Modal */
        #report-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .report-box { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .report-textarea { width: 100%; height: 80px; margin: 10px 0; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; resize: none; }
        .report-actions { text-align: right; margin-top: 10px; }
        .btn-cancel { background: #999; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-right: 10px; }
        .btn-submit { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }

        /* Navigation */
        nav { display: flex; justify-content: center; background: #fff; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; flex-wrap: wrap; gap: 10px; }
        .nav-group { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center;}
        nav button { background: #f8f9fa; border: 1px solid #e9ecef; color: #555; font-size: 14px; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.2s; font-weight: bold; }
        nav button:hover { background: #eef2ff; color: #667eea; border-color: #c7d2fe; }
        nav button.active { background: #667eea; color: white; border-color: #667eea; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4); }
        nav button.quiz-btn { border-color: #ffdbf0; background: #fff0f6; color: #d63384; }
        nav button.quiz-btn.active { background: #d63384; color: white; border-color: #d63384; }
        nav button.exam-btn { border-color: #ffe8cc; background: #fff4e6; color: #e8590c; }
        nav button.exam-btn.active { background: #fd7e14; color: white; border-color: #fd7e14; }

        .container { max-width: 900px; margin: 30px auto; padding: 0 20px; padding-bottom: 60px;}
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loading */
        #loading-msg { text-align: center; font-size: 20px; color: #667eea; margin-top: 50px; display: none;}
        #error-msg { text-align: center; color: red; margin-top: 50px; display: none; border: 1px solid red; padding: 20px; background: #fff0f0; border-radius: 10px;}

        /* Components */
        .setup-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .setup-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-left: 4px solid #667eea; padding-left: 10px; color: #444; }
        .cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .cat-label { display: block; background: #f8f9fa; padding: 10px; border-radius: 8px; cursor: pointer; border: 1px solid #eee; font-size: 14px; }
        .cat-label.checked { background: #e0e7ff; border-color: #667eea; color: #4338ca; font-weight: bold; }
        
        .quiz-box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; max-width: 600px; margin: 0 auto; }
        .q-score { font-size: 14px; color: #888; margin-bottom: 10px; font-weight: bold;}
        .q-text { font-size: 22px; margin-bottom: 25px; font-weight: bold; color: #333; line-height: 1.5; }
        .q-opt { padding: 15px; border: 2px solid #e0e7ff; border-radius: 8px; background: white; cursor: pointer; margin-bottom: 10px; text-align: left; transition:0.2s;}
        .q-opt:hover { background: #f8f9ff; }
        .q-opt.correct { background: #d1fae5; border-color: #10b981; }
        .q-opt.wrong { background: #fee2e2; border-color: #ef4444; }
        .q-feedback { margin-top: 20px; font-weight: bold; min-height: 20px; padding: 10px; border-radius: 5px; }
        .next-btn { margin-top:20px; padding:12px 30px; background:#667eea; color:white; border:none; border-radius:25px; cursor:pointer; font-size: 16px; font-weight:bold;}
        .start-btn { width: 100%; padding: 15px; font-size: 18px; background: #20c997; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        /* ä¿®æ­£å¾Œçš„ Report Button Style */
        .report-btn { 
            display: inline-block;
            margin-top: 10px;
            background: white; 
            color: #999; 
            border: 1px solid #ddd; 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 13px; 
            cursor: pointer; 
            transition: 0.2s;
        }
        .report-btn:hover { background: #fff0f0; color: #e74c3c; border-color: #e74c3c; }

        /* å–®å­—åº« */
        .vocab-cats { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; justify-content: center; }
        .v-cat-btn { background: white; border: 1px solid #ddd; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: 0.2s; }
        .v-cat-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .vocab-item { background: white; padding: 15px; border-radius: 8px; border-left: 5px solid #667eea; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .phrase-item { border-left-color: #e91e63; }
        .v-word { font-size: 18px; font-weight: bold; color: #2c3e50; }
        .v-mean { color: #e67e22; font-weight: bold; margin: 5px 0; }

        /* å–®å­—å¡ */
        .flashcard-area { display: flex; flex-direction: column; align-items: center; margin-top: 30px; perspective: 1000px; }
        .flashcard { width: 320px; height: 220px; background: white; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); cursor: pointer; position: relative; transform-style: preserve-3d; transition: transform 0.6s; }
        .flashcard.flipped { transform: rotateY(180deg); }
        .fc-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 15px; padding: 20px; box-sizing: border-box; text-align: center; }
        .fc-front { background: white; color: #333; }
        .fc-back { background: #667eea; color: white; transform: rotateY(180deg); }
        .fc-controls { margin-top: 20px; display: flex; align-items: center; gap: 15px; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; border: none; background: #ddd; cursor: pointer; font-size: 18px; transition: 0.2s; }
        .btn-circle:hover { background: #bbb; }

        /* æ–‡æ³• */
        .grammar-list { display: grid; gap: 15px; }
        .grammar-item { background: white; padding: 20px; border-radius: 8px; border-left: 5px solid #e67e22; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .g-title { font-size: 18px; font-weight: bold; color: #d35400; }
        
        /* å…¶ä»– */
        .cloze-sentence { font-size: 20px; color: #2c3e50; background: #f0f4f8; padding: 15px; border-radius: 8px; border-left: 5px solid #20c997; text-align: left;}
        .hint-text { font-size: 14px; color: #888; margin-bottom: 5px; }
        .q-tag { display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; margin-bottom: 15px; color: white; font-weight: bold;}
        .tag-memory { background: #d63384; }
        .tag-cloze { background: #20c997; }
        .tag-grammar { background: #fd7e14; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>ğŸ‘‹ ç‰¹è¨“ç­ç™»å…¥</h2>
        <p>è¼¸å…¥åå­—é–‹å§‹ç´€éŒ„æ•¸æ“š</p>
        <input type="text" id="username-input" class="login-input" placeholder="ä¾‹å¦‚ï¼šå¼Ÿå¼Ÿ">
        <button class="login-btn" onclick="loginUser()">é–‹å§‹å­¸ç¿’</button>
    </div>
</div>

<div id="report-modal">
    <div class="report-box">
        <h3 style="margin-top:0; color:#e74c3c;">ğŸš© å›å ±é¡Œç›®å•é¡Œ</h3>
        <div style="font-size:14px; color:#666; margin-bottom:10px; background:#f9f9f9; padding:10px; border-radius:5px;">
            <strong>é¡Œç›®ï¼š</strong> <span id="report-q-content">...</span>
        </div>
        <p style="margin:0; font-size:14px;">é€™é¡Œæœ‰ä»€éº¼å•é¡Œï¼Ÿ</p>
        <textarea id="report-comment" class="report-textarea" placeholder="ä¾‹å¦‚ï¼šç­”æ¡ˆæ€ªæ€ªçš„..."></textarea>
        <div class="report-actions">
            <button class="btn-cancel" onclick="closeReportModal()">å–æ¶ˆ</button>
            <button class="btn-submit" onclick="submitReport()">é€å‡º</button>
        </div>
    </div>
</div>

<header>
    <div id="user-display"></div>
    <h1>ğŸš€ ç§ä¸­è‹±èªç‰¹è¨“ç­</h1>
    <div class="subtitle">å–®å­—èˆ‡æ–‡æ³•åŠ å¼·ç‰ˆï¼ˆæ¸¬è©¦ä¸­...ï¼‰</div>
</header>

<nav>
    <div class="nav-group">
        <button onclick="showTab('vocab')" class="active" id="btn-vocab">ğŸ“š å–®å­—åº«</button>
        <button onclick="showTab('flashcard')" id="btn-flashcard">ğŸ“‡ ç¿»å¡</button>
        <button onclick="showTab('grammar')" id="btn-grammar">ğŸ’¡ æ–‡æ³•</button>
    </div>
    <div class="nav-group">
        <button onclick="showTab('quiz-memory')" class="quiz-btn" id="btn-quiz-memory">ğŸ§  å–®å­—æ¸¬é©—</button>
        <button onclick="showTab('quiz-cloze')" class="quiz-btn" id="btn-quiz-cloze">ğŸ“ å¡«ç©ºæ¸¬é©—</button>
        <button onclick="showTab('quiz-grammar')" class="quiz-btn" id="btn-quiz-grammar">âœï¸ æ–‡æ³•æ¸¬é©—</button>
        <button onclick="showTab('quiz-mixed')" class="exam-btn" id="btn-quiz-mixed">ğŸ”¥ ç¶œåˆæ¨¡æ“¬è€ƒ</button>
    </div>
</nav>

<div id="loading-msg">æ­£åœ¨è®€å– data.json ...</div>
<div id="error-msg">
    <h3>âš ï¸ ç„¡æ³•è®€å– data.json</h3>
    <p>è«‹ç¢ºèª GitHub Repository ä¸­å·²ä¸Šå‚³ data.json æª”æ¡ˆã€‚</p>
</div>

<div class="container" id="main-content" style="display: none;">
    
    <div id="vocab" class="section active">
        <div class="vocab-cats" id="vocab-cat-btns"></div>
        <div class="vocab-grid" id="vocab-container"></div>
    </div>

    <div id="flashcard" class="section">
        <div id="fc-setup" class="setup-box">
            <div class="setup-title">ç¿»å¡ç·´ç¿’è¨­å®š</div>
            <div class="cat-grid" id="fc-cat-list"></div>
            <button class="start-btn" onclick="initFlashcardSession()">é–‹å§‹ç·´ç¿’</button>
        </div>
        <div id="fc-game" style="display:none;">
            <button onclick="endSession('ç¿»å¡ç·´ç¿’', 0, 0, 'flashcard')" style="float:right; padding:5px 10px; background:#e74c3c; color:white; border:none; border-radius:5px; cursor:pointer;">â¹ çµæŸä¸¦ä¸Šå‚³ç´€éŒ„</button>
            <button onclick="resetSection('flashcard')" style="margin-bottom:10px;">â† é‡é¸ä¸»é¡Œ</button>
            <div class="flashcard-area">
                <div class="flashcard" id="card" onclick="flipCard()">
                    <div class="fc-face fc-front">
                        <h2 id="fc-word">Word</h2>
                        <span id="fc-part" style="margin-top:10px; background:#eee; padding:2px 8px; border-radius:10px; font-size:14px;">part</span>
                        <p style="margin-top:20px; color:#999; font-size:14px;">(é»æ“Šç¿»é¢)</p>
                    </div>
                    <div class="fc-face fc-back">
                        <h3 id="fc-mean">Meaning</h3>
                        <p id="fc-ex" style="font-style:italic; font-size:16px;">Ex</p>
                    </div>
                </div>
                <div class="fc-controls">
                    <button class="btn-circle" onclick="prevCard()">â€¹</button>
                    <span id="fc-count" style="font-weight:bold;">1 / 50</span>
                    <button class="btn-circle" onclick="nextCard()">â€º</button>
                </div>
            </div>
        </div>
    </div>

    <div id="grammar" class="section">
        <div class="grammar-list" id="grammar-container"></div>
    </div>

    <div id="quiz-memory" class="section">
        <div id="m-setup" class="setup-box">
            <div class="setup-title">å–®å­—æ¸¬é©—è¨­å®š</div>
            <div class="cat-grid" id="m-cat-list"></div>
            <button class="start-btn" onclick="initMemorySession()">é–‹å§‹æ¸¬é©—</button>
        </div>
        <div id="m-game" class="quiz-box" style="display:none;">
            <button onclick="endSession('å–®å­—æ¸¬é©—', mScore, mTotal, 'quiz-memory')" style="float:right; font-size:12px;">çµæŸä¸¦ä¸Šå‚³</button>
            <div class="q-score">ç´¯ç©ç­”å°ï¼š<span id="m-score">0</span></div>
            <div class="q-text" id="m-question">é¡Œç›®</div>
            <div class="q-options" id="m-options"></div>
            <div id="m-feedback"></div>
            <button id="m-next-btn" class="next-btn" style="display:none" onclick="nextMemoryQ()">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="quiz-cloze" class="section">
        <div id="c-setup" class="setup-box">
            <div class="setup-title">å¡«ç©ºæ¸¬é©—è¨­å®š</div>
            <div class="cat-grid" id="c-cat-list"></div>
            <button class="start-btn" onclick="initClozeSession()">é–‹å§‹æ¸¬é©—</button>
        </div>
        <div id="c-game" class="quiz-box" style="display:none;">
            <button onclick="endSession('å¡«ç©ºæ¸¬é©—', cScore, cTotal, 'quiz-cloze')" style="float:right; font-size:12px;">çµæŸä¸¦ä¸Šå‚³</button>
            <div class="q-score">ç´¯ç©ç­”å°ï¼š<span id="c-score">0</span></div>
            <div style="background:#f0f4f8; padding:15px; margin:15px 0; text-align:left; border-left:5px solid #20c997; font-size:20px;" id="c-sentence">...</div>
            <div style="color:#888; margin-bottom:20px;" id="c-hint"></div>
            <div class="q-options" id="c-options"></div>
            <div id="c-feedback"></div>
            <button id="c-next-btn" class="next-btn" style="display:none" onclick="nextClozeQ()">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="quiz-grammar" class="section">
        <div id="g-setup" class="setup-box">
            <div class="setup-title">æ–‡æ³•æŒ‘æˆ°</div>
            <p style="color:#666; margin-bottom:20px;">é¡Œåº«æ”¶éŒ„é‡é»æ–‡æ³•ï¼Œæ¯æ¬¡æ¸¬é©—éš¨æ©Ÿå‡ºé¡Œã€‚</p>
            <button class="start-btn" onclick="initGrammarSession()">é–‹å§‹æ–‡æ³•æ¸¬é©—</button>
        </div>
        <div id="g-game" class="quiz-box" style="display:none;">
            <button onclick="endSession('æ–‡æ³•æ¸¬é©—', gScore, gTotal, 'quiz-grammar')" style="float:right; font-size:12px;">çµæŸä¸¦ä¸Šå‚³</button>
            <div class="q-score">å¾—åˆ†ï¼š<span id="g-score">0</span> / <span id="g-total">0</span></div>
            <h2 id="g-question" class="q-text">Q</h2>
            <div class="q-options" id="g-options"></div>
            <div id="g-feedback" class="q-feedback"></div>
            <button id="g-next-btn" class="next-btn" style="display:none" onclick="nextGrammarQ()">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="quiz-mixed" class="section">
        <div class="quiz-box">
            <div class="q-score" id="x-score">é€²åº¦ï¼š1 / 20 | å¾—åˆ†ï¼š0</div>
            <div id="x-tag-container"></div>
            <div id="x-content">
                <div class="q-text" id="x-question">é¡Œç›®è¼‰å…¥ä¸­...</div>
                <div id="x-extra-info" style="color:#666; margin-bottom:10px;"></div>
                <div class="q-options" id="x-options"></div>
            </div>
            <div id="x-feedback"></div>
            <button id="x-next-btn" class="next-btn" style="display:none" onclick="nextMixedQuestion()">ä¸‹ä¸€é¡Œ</button>
            <button id="x-restart-btn" class="next-btn" style="display:none; background:#20c997;" onclick="initMixedQuiz()">å†è€ƒä¸€æ¬¡</button>
        </div>
    </div>

</div>

<script>
    // ==========================================
    // âš ï¸ è«‹å°‡ä¸‹æ–¹ç¶²å€æ›æˆä½ çš„ Apps Script ç¶²å€
    // ==========================================
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwc96555C6SWdZlcfbLvWt9_ZaxYklV37sTOLoq32QoqatiI7icbi422mp45TF31UEa/exec'; 

    let currentUser = "";
    let data = {};
    let allCategories = [];
    
    // Data Tracking
    let sessionStartTime = 0;
    let sessionThemes = []; 
    let sessionMistakes = []; 
    let currentQuestionText = ""; 

    // Quiz State
    let activeList = [];
    let fcIdx=0;
    let mScore=0, mTotal=0, mAns=-1;
    let cScore=0, cTotal=0, cAns=-1;
    let gList=[], gIdx=0, gScore=0, gTotal=0;
    let xQuestions=[], xIndex=0, xScore=0, xAns=-1;

    // Init
    window.onload = async function() {
        document.getElementById('loading-msg').style.display = 'block';
        try {
            const response = await fetch('data.json');
            if (!response.ok) throw new Error("HTTP error");
            data = await response.json();
            
            document.getElementById('loading-msg').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            initApp();
        } catch (error) {
            console.error(error);
            document.getElementById('loading-msg').style.display = 'none';
            document.getElementById('error-msg').style.display = 'block';
        }
    };

    function loginUser() {
        const name = document.getElementById('username-input').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥åå­—ï¼");
        currentUser = name;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('user-display').innerText = `å­¸å“¡ï¼š${currentUser}`;
    }

    function initApp() {
        const catSet = new Set(data.vocabulary.map(v => v.category || 'å…¶ä»–'));
        allCategories = [...catSet];
        
        initVocabView();
        initGrammarView();
        renderMultiSelect('fc-cat-list');
        renderMultiSelect('m-cat-list');
        renderMultiSelect('c-cat-list');
    }

    // --- å›å ±å•é¡ŒåŠŸèƒ½ ---
    function openReportModal() {
        document.getElementById('report-q-content').innerText = currentQuestionText;
        document.getElementById('report-comment').value = "";
        document.getElementById('report-modal').style.display = 'flex';
    }
    function closeReportModal() {
        document.getElementById('report-modal').style.display = 'none';
    }
    function submitReport() {
        if(!GOOGLE_SCRIPT_URL.includes("script.google.com")) return alert("è«‹å…ˆè¨­å®š Google Script ç¶²å€");
        const qText = document.getElementById('report-q-content').innerText;
        const comment = document.getElementById('report-comment').value;
        
        const payload = {
            action: 'report_issue',
            name: currentUser,
            question: qText,
            comment: comment
        };
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST', mode: 'no-cors', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(()=>{
            alert("æ„Ÿè¬å›å ±ï¼");
            closeReportModal();
        }).catch(e => alert("å‚³é€å¤±æ•—"));
    }

    // --- è³‡æ–™å‚³è¼¸ ---
    function startTracking(themesArray) {
        sessionStartTime = Date.now();
        sessionThemes = themesArray || ["ç¶œåˆ/éš¨æ©Ÿ"];
        sessionMistakes = []; 
    }
    function recordMistake(question, correctAnswer) {
        sessionMistakes.push(`[é¡Œç›®]: ${question} | [æ­£è§£]: ${correctAnswer}`);
    }
    function endSession(type, score, total, resetId) {
        const duration = Math.round((Date.now() - sessionStartTime) / 1000);
        const themesStr = sessionThemes.join(", ");
        
        if(GOOGLE_SCRIPT_URL.includes("script.google.com")) {
            const payload = {
                action: 'submit_score',
                name: currentUser,
                type: type,
                score: score,
                total: total,
                duration: duration,
                themes: themesStr,
                mistakes: sessionMistakes
            };
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).catch(e => console.log(e));
        }
        alert(`ç´€éŒ„å·²ä¸Šå‚³ï¼\nè€—æ™‚ï¼š${duration}ç§’`);
        resetSection(resetId);
    }

    // --- ä»‹é¢ Helper ---
    function showTab(id) {
        document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+id).classList.add('active');
        if(id==='quiz-mixed') initMixedQuiz();
    }
    function resetSection(id) {
        if(id==='flashcard') { document.getElementById('fc-setup').style.display='block'; document.getElementById('fc-game').style.display='none'; }
        if(id==='quiz-memory') { document.getElementById('m-setup').style.display='block'; document.getElementById('m-game').style.display='none'; }
        if(id==='quiz-cloze') { document.getElementById('c-setup').style.display='block'; document.getElementById('c-game').style.display='none'; }
        if(id==='quiz-grammar') { document.getElementById('g-setup').style.display='block'; document.getElementById('g-game').style.display='none'; }
    }
    function getReportBtn() { 
        // å›å ±æŒ‰éˆ•æ”¹ç‚º div åŒ…è£¹çš„ block æŒ‰éˆ•ï¼Œç¢ºä¿æ›è¡Œ
        return `<div style="margin-top:10px; text-align:right;"><button class="report-btn" onclick="openReportModal()">ğŸš© å›å ±å•é¡Œ</button></div>`; 
    }

    // --- å¤šé¸å–® & å–®å­—åº« ---
    function renderMultiSelect(id) {
        const div = document.getElementById(id);
        div.innerHTML = `<label class="cat-label"><input type="checkbox" value="PHRASES"> ç‰‡èª (Phrases)</label>`;
        allCategories.forEach(c => {
            div.innerHTML += `<label class="cat-label"><input type="checkbox" value="${c}"> ${c}</label>`;
        });
        div.querySelectorAll('input').forEach(input => {
            input.parentElement.onclick = function() {
                if(input.checked) this.classList.add('checked'); else this.classList.remove('checked');
            }
        });
    }
    function getSelectedThemes(id) { return Array.from(document.querySelectorAll(`#${id} input:checked`)).map(cb => cb.value); }
    function getSelectedItems(id) {
        const inputs = document.querySelectorAll(`#${id} input:checked`);
        let items = [];
        inputs.forEach(input => {
            if(input.value === 'PHRASES') items = items.concat(data.phrases || []);
            else items = items.concat(data.vocabulary.filter(v => (v.category||'å…¶ä»–') === input.value));
        });
        return items;
    }
    function initVocabView() {
        const div = document.getElementById('vocab-cat-btns');
        div.innerHTML = '';
        const pBtn = document.createElement('button');
        pBtn.className = 'v-cat-btn';
        pBtn.innerText = "ğŸ—£ï¸ ç‰‡èª (Phrases)";
        pBtn.onclick = () => renderVocabList('PHRASES', pBtn);
        div.appendChild(pBtn);
        allCategories.forEach((c, i) => {
            const btn = document.createElement('button');
            btn.className = 'v-cat-btn';
            btn.innerText = c;
            btn.onclick = () => renderVocabList(c, btn);
            div.appendChild(btn);
            if(i===0 && (!data.phrases || data.phrases.length===0)) renderVocabList(c, btn);
        });
        if(data.phrases && data.phrases.length>0) renderVocabList('PHRASES', pBtn);
    }
    function renderVocabList(cat, btn) {
        document.querySelectorAll('.v-cat-btn').forEach(b=>b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        const div = document.getElementById('vocab-container');
        div.innerHTML = '';
        let items = (cat==='PHRASES') ? (data.phrases||[]) : data.vocabulary.filter(v=>(v.category||'å…¶ä»–')===cat);
        if(items.length===0) { div.innerHTML='<div style="text-align:center;grid-column:1/-1">ç„¡è³‡æ–™</div>'; return; }
        items.forEach(v => {
            const word = v.word || v.phrase;
            const part = v.part || 'phr.';
            const cls = (cat==='PHRASES') ? 'phrase-item' : '';
            div.innerHTML += `<div class="vocab-item ${cls}"><div class="v-word">${word} <span class="v-part">${part}</span></div><div class="v-mean">${v.meaning}</div><div class="v-ex">${v.example}</div></div>`;
        });
    }

    // --- ç¿»å¡ ---
    function initFlashcardSession() {
        const themes = getSelectedThemes('fc-cat-list');
        activeList = getSelectedItems('fc-cat-list');
        if(activeList.length===0) return alert('è«‹å‹¾é¸ä¸»é¡Œ');
        startTracking(themes);
        fcIdx=0; activeList.sort(()=>Math.random()-0.5);
        document.getElementById('fc-setup').style.display='none';
        document.getElementById('fc-game').style.display='block';
        renderFlashcard();
    }
    function renderFlashcard() {
        const item = activeList[fcIdx];
        document.getElementById('fc-word').innerText = item.word || item.phrase;
        document.getElementById('fc-part').innerText = item.part || 'phr.';
        document.getElementById('fc-mean').innerText = item.meaning;
        document.getElementById('fc-ex').innerText = item.example;
        document.getElementById('fc-count').innerText = `${fcIdx+1} / ${activeList.length}`;
        document.getElementById('card').classList.remove('flipped');
    }
    function flipCard() { document.getElementById('card').classList.toggle('flipped'); }
    function nextCard() { fcIdx=(fcIdx+1)%activeList.length; renderFlashcard(); }
    function prevCard() { fcIdx=(fcIdx-1+activeList.length)%activeList.length; renderFlashcard(); }

    // --- å–®å­—æ¸¬é©— ---
    function initMemorySession() {
        const themes = getSelectedThemes('m-cat-list');
        activeList = getSelectedItems('m-cat-list');
        if(activeList.length===0) return alert('è«‹å‹¾é¸ä¸»é¡Œ');
        startTracking(themes);
        mScore=0; mTotal=0;
        document.getElementById('m-setup').style.display='none';
        document.getElementById('m-game').style.display='block';
        nextMemoryQ();
    }
    function nextMemoryQ() {
        document.getElementById('m-score').innerText = mScore;
        document.getElementById('m-feedback').innerHTML = '';
        document.getElementById('m-next-btn').style.display='none';
        
        const item = activeList[Math.floor(Math.random()*activeList.length)];
        window.currentMItem = item; 
        currentQuestionText = `${item.meaning} (æ¸¬é©—: ${item.word||item.phrase})`;

        document.getElementById('m-question').innerHTML = `<span style="font-size:16px;color:#888">è«‹å•</span><br>${item.meaning}<br><span style="font-size:16px;color:#888">æ˜¯å“ªå€‹å­—ï¼Ÿ</span>`;
        
        let opts = [item.word || item.phrase];
        const pool = [...data.vocabulary, ...(data.phrases||[])];
        while(opts.length<4) {
            let r = pool[Math.floor(Math.random()*pool.length)];
            let w = r.word || r.phrase;
            if(!opts.includes(w)) opts.push(w);
        }
        opts.sort(()=>Math.random()-0.5);
        mAns = opts.indexOf(item.word || item.phrase);
        
        const div = document.getElementById('m-options');
        div.innerHTML='';
        opts.forEach((o, i) => {
            div.innerHTML += `<div class="q-opt" onclick="checkM(this, ${i})">${o}</div>`;
        });
        mTotal++;
    }
    function checkM(btn, i) {
        document.querySelectorAll('#m-options .q-opt').forEach(b=>b.style.pointerEvents='none');
        const feedback = document.getElementById('m-feedback');
        if(i===mAns) { 
            btn.classList.add('correct'); mScore++; 
            feedback.innerHTML=`<span style="color:#10b981; font-weight:bold;">âœ… æ­£ç¢º</span>${getReportBtn()}`; 
        } else { 
            btn.classList.add('wrong'); document.querySelectorAll('#m-options .q-opt')[mAns].classList.add('correct'); 
            feedback.innerHTML=`<span style="color:#ef4444; font-weight:bold;">âŒ éŒ¯èª¤</span>${getReportBtn()}`;
            recordMistake(window.currentMItem.meaning, (window.currentMItem.word||window.currentMItem.phrase));
        }
        document.getElementById('m-score').innerText = mScore;
        document.getElementById('m-next-btn').style.display='inline-block';
    }

    // --- å¡«ç©ºæ¸¬é©— ---
    function initClozeSession() {
        const themes = getSelectedThemes('c-cat-list');
        activeList = getSelectedItems('c-cat-list');
        if(activeList.length===0) return alert('è«‹å‹¾é¸ä¸»é¡Œ');
        startTracking(themes);
        cScore=0; cTotal=0;
        document.getElementById('c-setup').style.display='none';
        document.getElementById('c-game').style.display='block';
        nextClozeQ();
    }
    function nextClozeQ() {
        document.getElementById('c-score').innerText = cScore;
        document.getElementById('c-feedback').innerHTML='';
        document.getElementById('c-next-btn').style.display='none';
        
        let item, word, sent, attempts=0;
        while(true) {
            item = activeList[Math.floor(Math.random()*activeList.length)];
            word = item.word || item.phrase;
            sent = item.example;
            if(sent.toLowerCase().includes(word.toLowerCase())) break;
            if(attempts++ > 20) break;
        }
        window.currentCItem = item;
        currentQuestionText = sent;

        const regex = new RegExp(word, "gi");
        const qSent = sent.replace(regex, "______");
        document.getElementById('c-sentence').innerText = qSent;
        document.getElementById('c-hint').innerText = `æç¤ºï¼š${item.meaning}`;
        
        let opts = [word];
        const pool = [...data.vocabulary, ...(data.phrases||[])];
        while(opts.length<4) {
            let r = pool[Math.floor(Math.random()*pool.length)];
            let w = r.word || r.phrase;
            if(!opts.includes(w)) opts.push(w);
        }
        opts.sort(()=>Math.random()-0.5);
        cAns = opts.indexOf(word);
        
        const div = document.getElementById('c-options');
        div.innerHTML='';
        opts.forEach((o, i) => {
            div.innerHTML += `<div class="q-opt" onclick="checkC(this, ${i})">${o}</div>`;
        });
        cTotal++;
    }
    function checkC(btn, i) {
        document.querySelectorAll('#c-options .q-opt').forEach(b=>b.style.pointerEvents='none');
        const full = window.currentCItem.example;
        const feedback = document.getElementById('c-feedback');
        if(i===cAns) { 
            btn.classList.add('correct'); cScore++; 
            feedback.innerHTML=`<span style="color:#10b981; font-weight:bold;">âœ… æ­£ç¢º</span><br>${full}${getReportBtn()}`; 
        } else { 
            btn.classList.add('wrong'); document.querySelectorAll('#c-options .q-opt')[cAns].classList.add('correct'); 
            feedback.innerHTML=`<span style="color:#ef4444; font-weight:bold;">âŒ éŒ¯èª¤</span><br>${full}${getReportBtn()}`; 
            recordMistake(document.getElementById('c-sentence').innerText, (window.currentCItem.word||window.currentCItem.phrase));
        }
        document.getElementById('c-score').innerText = cScore;
        document.getElementById('c-next-btn').style.display='inline-block';
    }

    // --- æ–‡æ³• ---
    function initGrammarView() {
        const div = document.getElementById('grammar-container');
        if(data.grammarRules) data.grammarRules.forEach(g => div.innerHTML += `<div class="grammar-item"><div class="g-title">${g.title}</div><div>${g.content}</div></div>`);
    }
    function initGrammarSession() {
        if(!data.grammarQuiz || data.grammarQuiz.length===0) return alert("ç„¡é¡Œç›®");
        startTracking(["æ–‡æ³•"]);
        gScore=0; gTotal=0; gIdx=0;
        gList = [...data.grammarQuiz].sort(()=>Math.random()-0.5);
        document.getElementById('g-setup').style.display='none';
        document.getElementById('g-game').style.display='block';
        nextGrammarQ();
    }
    function nextGrammarQ() {
        if(gIdx >= gList.length) { endSession('æ–‡æ³•æ¸¬é©—', gScore, gTotal, 'quiz-grammar'); return; }
        document.getElementById('g-score').innerText = gScore;
        document.getElementById('g-feedback').innerHTML='';
        document.getElementById('g-next-btn').style.display='none';
        
        const q = gList[gIdx];
        window.currentGItem = q;
        currentQuestionText = q.q;

        document.getElementById('g-question').innerText = q.q;
        const div = document.getElementById('g-options');
        div.innerHTML='';
        q.options.forEach((o, i) => { div.innerHTML += `<div class="q-opt" onclick="checkG(this, ${i}, ${q.ans}, '${q.note.replace(/'/g, "\\'")}')">${o}</div>`; });
        gTotal++;
    }
    function checkG(btn, i, ans, note) {
        document.querySelectorAll('#g-options .q-opt').forEach(b=>b.style.pointerEvents='none');
        const feedback = document.getElementById('g-feedback');
        if(i===ans) { 
            btn.classList.add('correct'); gScore++; 
            feedback.innerHTML=`âœ… æ­£ç¢º<br><span style="font-size:14px;color:#555">${note}</span>${getReportBtn()}`; 
        } else { 
            btn.classList.add('wrong'); document.querySelectorAll('#g-options .q-opt')[ans].classList.add('correct'); 
            feedback.innerHTML=`âŒ éŒ¯èª¤<br><span style="font-size:14px;color:#555">${note}</span>${getReportBtn()}`;
            recordMistake(window.currentGItem.q, window.currentGItem.options[window.currentGItem.ans]);
        }
        document.getElementById('g-score').innerText = gScore;
        gIdx++;
        document.getElementById('g-next-btn').style.display='inline-block';
    }

    // --- ç¶œåˆæ¸¬é©— ---
    function initMixedQuiz() {
        startTracking(["ç¶œåˆæ¨¡æ“¬è€ƒ"]);
        xQuestions=[]; xIndex=0; xScore=0;
        document.getElementById('x-next-btn').style.display='none';
        document.getElementById('x-restart-btn').style.display='none';
        document.getElementById('x-content').style.display='block';
        
        const vPool = [...data.vocabulary, ...(data.phrases||[])];
        const gPool = [...(data.grammarQuiz||[])];
        
        for(let i=0; i<5; i++) xQuestions.push({type:'memory', item:vPool[Math.floor(Math.random()*vPool.length)]});
        for(let i=0; i<5; i++) {
            let item, attempts=0;
            while(attempts++<20) {
                item = vPool[Math.floor(Math.random()*vPool.length)];
                if(item.example.toLowerCase().includes((item.word||item.phrase).toLowerCase())) break;
            }
            xQuestions.push({type:'cloze', item:item});
        }
        gPool.sort(()=>Math.random()-0.5).slice(0,10).forEach(q=>xQuestions.push({type:'grammar', q:q}));
        xQuestions.sort(()=>Math.random()-0.5);
        nextMixedQuestion();
    }
    function nextMixedQuestion() {
        if(xIndex >= xQuestions.length) {
            endSession('ç¶œåˆæ¨¡æ“¬è€ƒ', xScore, 20, 'quiz-mixed');
            document.getElementById('x-content').style.display='none';
            document.getElementById('x-feedback').innerHTML = `<h2>æ¸¬é©—çµæŸ</h2><p>ç¸½åˆ†ï¼š${xScore} / 20</p>`;
            document.getElementById('x-next-btn').style.display='none';
            document.getElementById('x-restart-btn').style.display='inline-block';
            return;
        }
        document.getElementById('x-content').style.display='block';
        document.getElementById('x-feedback').innerHTML='';
        document.getElementById('x-next-btn').style.display='none';
        
        const q = xQuestions[xIndex];
        window.currentXItem = q;
        const div = document.getElementById('x-options');
        div.innerHTML='';
        document.getElementById('x-score').innerText = `é€²åº¦ï¼š${xIndex+1} / 20 | å¾—åˆ†ï¼š${xScore}`;
        
        let correctStr = "";
        if(q.type==='memory') {
            currentQuestionText = q.item.meaning;
            const word = q.item.word || q.item.phrase;
            correctStr = word;
            document.getElementById('x-tag-container').innerHTML = '<span class="q-tag tag-memory">å–®å­—è¨˜æ†¶</span>';
            document.getElementById('x-question').innerHTML = `<span style="font-size:16px;">${q.item.meaning}</span> æ˜¯å“ªå€‹å­—ï¼Ÿ`;
            document.getElementById('x-extra-info').innerText = '';
            let opts = [word];
            const pool = [...data.vocabulary, ...(data.phrases||[])];
            while(opts.length<4) { let w = (pool[Math.floor(Math.random()*pool.length)]).word||(pool[Math.floor(Math.random()*pool.length)]).phrase; if(!opts.includes(w)) opts.push(w); }
            opts.sort(()=>Math.random()-0.5);
            xAns = opts.indexOf(word);
            opts.forEach((o, i) => div.innerHTML+=`<div class="q-opt" onclick="checkX(this, ${i}, '${correctStr}')">${o}</div>`);
        } else if(q.type==='cloze') {
            const word = q.item.word || q.item.phrase;
            correctStr = word;
            const regex = new RegExp(word, "gi");
            const qSent = q.item.example.replace(regex, "______");
            currentQuestionText = qSent;
            document.getElementById('x-tag-container').innerHTML = '<span class="q-tag tag-cloze">å¥å­å¡«ç©º</span>';
            document.getElementById('x-question').innerHTML = qSent;
            document.getElementById('x-extra-info').innerText = `æç¤º: ${q.item.meaning}`;
            let opts = [word];
            const pool = [...data.vocabulary, ...(data.phrases||[])];
            while(opts.length<4) { let w = (pool[Math.floor(Math.random()*pool.length)]).word||(pool[Math.floor(Math.random()*pool.length)]).phrase; if(!opts.includes(w)) opts.push(w); }
            opts.sort(()=>Math.random()-0.5);
            xAns = opts.indexOf(word);
            opts.forEach((o, i) => div.innerHTML+=`<div class="q-opt" onclick="checkX(this, ${i}, '${correctStr}')">${o}</div>`);
        } else {
            currentQuestionText = q.q.q;
            document.getElementById('x-tag-container').innerHTML = '<span class="q-tag tag-grammar">æ–‡æ³•</span>';
            document.getElementById('x-question').innerText = q.q.q;
            document.getElementById('x-extra-info').innerText = '';
            xAns = q.q.ans;
            correctStr = q.q.options[xAns];
            q.q.options.forEach((o, i) => div.innerHTML+=`<div class="q-opt" onclick="checkX(this, ${i}, '${correctStr}', '${q.q.note.replace(/'/g, "\\'")}')">${o}</div>`);
        }
    }
    function checkX(btn, i, correctStr, note) {
        document.querySelectorAll('#x-options .q-opt').forEach(b=>b.style.pointerEvents='none');
        const feedback = document.getElementById('x-feedback');
        if(i===xAns) { 
            btn.classList.add('correct'); xScore++; 
            feedback.innerHTML=`âœ… æ­£ç¢º${getReportBtn()}`; 
        } else { 
            btn.classList.add('wrong'); document.querySelectorAll('#x-options .q-opt')[xAns].classList.add('correct'); 
            feedback.innerHTML=`âŒ éŒ¯èª¤${getReportBtn()}`; 
            
            let qTitle = "";
            if(window.currentXItem.type === 'grammar') qTitle = window.currentXItem.q.q;
            else if(window.currentXItem.type === 'memory') qTitle = window.currentXItem.item.meaning;
            else qTitle = "å¥å­å¡«ç©ºé¡Œ";
            recordMistake(qTitle, correctStr);
        }
        if(note) feedback.innerHTML += `<br><span style="font-size:14px;color:#555">${note}</span>`;
        xIndex++;
        document.getElementById('x-next-btn').style.display='inline-block';
    }
</script>

</body>
</html>