<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§ä¸­è‹±èªç‰¹è¨“ç­ (é›²ç«¯ç´€éŒ„ç‰ˆ)</title>
    <style>
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: #f4f7f6; margin: 0; color: #333; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        h1 { margin: 0; font-size: 28px; }
        .subtitle { opacity: 0.8; font-size: 14px; margin-top: 5px; }
        
        /* ç™»å…¥ç•«é¢ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-input { width: 80%; padding: 10px; margin: 20px 0; font-size: 18px; border: 2px solid #ddd; border-radius: 5px; }
        .login-btn { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; }
        
        nav { display: flex; justify-content: center; background: #fff; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; flex-wrap: wrap; gap: 10px; }
        .nav-group { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center;}
        nav button { background: #f8f9fa; border: 1px solid #e9ecef; color: #555; font-size: 14px; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.2s; font-weight: bold; }
        nav button:hover { background: #eef2ff; color: #667eea; border-color: #c7d2fe; }
        nav button.active { background: #667eea; color: white; border-color: #667eea; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4); }
        nav button.quiz-btn { border-color: #ffdbf0; background: #fff0f6; color: #d63384; }
        nav button.quiz-btn.active { background: #d63384; color: white; border-color: #d63384; }
        nav button.exam-btn { border-color: #ffe8cc; background: #fff4e6; color: #e8590c; }
        nav button.exam-btn.active { background: #fd7e14; color: white; border-color: #fd7e14; }

        .container { max-width: 900px; margin: 30px auto; padding: 0 20px; padding-bottom: 60px;}
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Setup Box */
        .setup-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .cat-label { display: block; background: #f8f9fa; padding: 10px; border-radius: 8px; cursor: pointer; border: 1px solid #eee; font-size: 14px; }
        .cat-label.checked { background: #e0e7ff; border-color: #667eea; color: #4338ca; font-weight: bold; }
        
        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .vocab-item { background: white; padding: 15px; border-radius: 8px; border-left: 5px solid #667eea; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .v-word { font-size: 18px; font-weight: bold; color: #2c3e50; }
        .v-mean { color: #e67e22; font-weight: bold; margin: 5px 0; }
        
        .quiz-box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; max-width: 600px; margin: 0 auto; }
        .q-opt { padding: 15px; border: 2px solid #e0e7ff; border-radius: 8px; background: white; cursor: pointer; margin-bottom: 10px; text-align: left;}
        .q-opt.correct { background: #d1fae5; border-color: #10b981; }
        .q-opt.wrong { background: #fee2e2; border-color: #ef4444; }
        .next-btn { margin-top:20px; padding:12px 30px; background:#667eea; color:white; border:none; border-radius:25px; cursor:pointer; }
        
        .start-btn { width: 100%; padding: 15px; background: #20c997; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 18px;}
        .grammar-item { background: white; padding: 20px; border-radius: 8px; border-left: 5px solid #e67e22; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px;}
        .g-title { font-size: 18px; font-weight: bold; color: #d35400; }
        
        /* ç‹€æ…‹é¡¯ç¤º */
        #user-display { position: absolute; top: 10px; right: 20px; color: white; font-weight: bold; font-size: 14px;}
        .saving-status { font-size: 12px; color: #888; margin-top: 10px; font-style: italic;}
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>ğŸ‘‹ æ­¡è¿ä¾†åˆ°ç‰¹è¨“ç­</h2>
        <p>è«‹è¼¸å…¥ä½ çš„åå­—ä»¥é–‹å§‹ç´€éŒ„</p>
        <input type="text" id="username-input" class="login-input" placeholder="ä¾‹å¦‚ï¼šå¼Ÿå¼Ÿ">
        <button class="login-btn" onclick="loginUser()">é–‹å§‹å­¸ç¿’</button>
    </div>
</div>

<header>
    <div id="user-display"></div>
    <h1>ğŸš€ ç§ä¸­è‹±èªç‰¹è¨“ç­</h1>
    <div class="subtitle">GitHub é›²ç«¯ç´€éŒ„ç‰ˆ</div>
</header>

<nav>
    <div class="nav-group">
        <button onclick="showTab('vocab')" class="active" id="btn-vocab">ğŸ“š å–®å­—ç‰‡èª</button>
        <button onclick="showTab('flashcard')" id="btn-flashcard">ğŸ“‡ ç¿»å¡</button>
        <button onclick="showTab('grammar')" id="btn-grammar">ğŸ’¡ æ–‡æ³•</button>
    </div>
    <div class="nav-group">
        <button onclick="showTab('quiz-memory')" class="quiz-btn" id="btn-quiz-memory">ğŸ§  å–®å­—æ¸¬é©—</button>
        <button onclick="showTab('quiz-cloze')" class="quiz-btn" id="btn-quiz-cloze">ğŸ“ å¡«ç©ºæ¸¬é©—</button>
        <button onclick="showTab('quiz-grammar')" class="quiz-btn" id="btn-quiz-grammar">âœï¸ æ–‡æ³•æ¸¬é©—</button>
        <button onclick="showTab('quiz-mixed')" class="exam-btn" id="btn-quiz-mixed">ğŸ”¥ ç¶œåˆæ¨¡æ“¬è€ƒ</button>
    </div>
</nav>

<div class="container" id="main-content">
    <div id="vocab" class="section active">
        <div id="vocab-cat-btns" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:20px; justify-content:center;"></div>
        <div class="vocab-grid" id="vocab-container"></div>
    </div>
    
    <div id="flashcard" class="section">
        <div id="fc-setup" class="setup-box">
            <h3>å‹¾é¸ç·´ç¿’ä¸»é¡Œ</h3>
            <div class="cat-grid" id="fc-cat-list"></div>
            <button class="start-btn" onclick="initFlashcardSession()">é–‹å§‹</button>
        </div>
        <div id="fc-game" style="display:none; text-align:center;">
            <button onclick="resetSection('flashcard')">â† é‡é¸</button>
            <div style="margin-top:20px; background:white; padding:40px; border-radius:10px; cursor:pointer; min-height:150px;" onclick="document.getElementById('fc-back').style.display='block'">
                <h2 id="fc-word">Word</h2>
                <div id="fc-back" style="display:none; color:#e67e22; margin-top:20px;">
                    <h3 id="fc-mean">Meaning</h3>
                    <p id="fc-ex">Ex</p>
                </div>
            </div>
            <div style="margin-top:20px;">
                <button onclick="nextCard()">ä¸‹ä¸€å¼µ</button>
            </div>
        </div>
    </div>

    <div id="grammar" class="section">
        <div class="grammar-list" id="grammar-container"></div>
    </div>

    <div id="quiz-memory" class="section">
        <div id="m-setup" class="setup-box">
            <h3>å‹¾é¸æ¸¬é©—ä¸»é¡Œ</h3>
            <div class="cat-grid" id="m-cat-list"></div>
            <button class="start-btn" onclick="initMemorySession()">é–‹å§‹æ¸¬é©—</button>
        </div>
        <div id="m-game" class="quiz-box" style="display:none;">
            <button onclick="endQuiz('å–®å­—æ¸¬é©—', mScore, mTotal, 'quiz-memory')" style="float:right;">çµæŸä¸¦ä¸Šå‚³</button>
            <div>å¾—åˆ†ï¼š<span id="m-score">0</span></div>
            <h2 id="m-question">Q</h2>
            <div id="m-options" style="margin-top:20px;"></div>
            <div id="m-feedback"></div>
            <button id="m-next-btn" class="next-btn" style="display:none" onclick="nextMemoryQ()">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="quiz-cloze" class="section">
        <div id="c-setup" class="setup-box">
            <h3>å‹¾é¸æ¸¬é©—ä¸»é¡Œ</h3>
            <div class="cat-grid" id="c-cat-list"></div>
            <button class="start-btn" onclick="initClozeSession()">é–‹å§‹æ¸¬é©—</button>
        </div>
        <div id="c-game" class="quiz-box" style="display:none;">
            <button onclick="endQuiz('å¡«ç©ºæ¸¬é©—', cScore, cTotal, 'quiz-cloze')" style="float:right;">çµæŸä¸¦ä¸Šå‚³</button>
            <div>å¾—åˆ†ï¼š<span id="c-score">0</span></div>
            <div style="background:#f0f4f8; padding:15px; margin:15px 0; text-align:left; border-left:5px solid #20c997;" id="c-sentence">...</div>
            <div style="color:#888;" id="c-hint"></div>
            <div id="c-options" style="margin-top:20px;"></div>
            <div id="c-feedback"></div>
            <button id="c-next-btn" class="next-btn" style="display:none" onclick="nextClozeQ()">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="quiz-grammar" class="section">
        <div id="g-setup" class="setup-box">
            <div class="setup-title">æ–‡æ³•æŒ‘æˆ°</div>
            <p style="color:#666; margin-bottom:20px;">é¡Œåº«æ”¶éŒ„ç´„ 100 é¡Œé‡é»æ–‡æ³•ï¼Œæ¯æ¬¡æ¸¬é©—å°‡éš¨æ©Ÿå‡ºé¡Œã€‚</p>
            <button class="start-btn" onclick="initGrammarSession()">é–‹å§‹æ–‡æ³•æ¸¬é©—</button>
        </div>

        <div id="g-game" class="quiz-box" style="display:none;">
            <button onclick="endQuiz('æ–‡æ³•æ¸¬é©—', gScore, gTotal, 'quiz-grammar')" style="float:right; font-size:12px; cursor:pointer;">çµæŸä¸¦ä¸Šå‚³</button>
            <div class="q-score">å¾—åˆ†ï¼š<span id="g-score">0</span> / <span id="g-total">0</span></div>
            
            <h2 id="g-question" class="q-text">Q</h2>
            
            <div id="g-options" style="margin-top:20px;"></div>
            <div id="g-feedback" class="q-feedback"></div>
            <button id="g-next-btn" class="next-btn" style="display:none" onclick="nextGrammarQ()">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="quiz-mixed" class="section">
        <div class="quiz-box">
            <div id="x-info"></div>
            <div id="x-content">
                <span id="x-tag" style="background:#667eea; color:white; padding:3px 8px; border-radius:10px; font-size:12px;">Tag</span>
                <h2 id="x-question">Q</h2>
                <div id="x-extra" style="color:#666; margin-bottom:10px;"></div>
                <div id="x-options"></div>
            </div>
            <div id="x-feedback"></div>
            <button id="x-next-btn" class="next-btn" style="display:none" onclick="nextMixedQ()">ä¸‹ä¸€é¡Œ</button>
            <button id="x-restart-btn" class="next-btn" style="display:none; background:#20c997;" onclick="initMixedQuiz()">å†è€ƒä¸€æ¬¡</button>
            <div id="save-status" class="saving-status"></div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // âš ï¸ è¨­å®šå€ï¼šè«‹å°‡ä¸‹æ–¹çš„ URL æ›æˆä½ çš„ Google Apps Script ç¶²å€
    // ==========================================
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwc96555C6SWdZlcfbLvWt9_ZaxYklV37sTOLoq32QoqatiI7icbi422mp45TF31UEa/exec'; 
    // ä¾‹å¦‚: https://script.google.com/macros/s/AKfycbx.../exec

    let currentUser = "";
    let data = {};
    let allCategories = [];
    
    // æ¸¬é©—ç‹€æ…‹
    let activeList = [];
    let fcIdx=0;
    let mScore=0, mTotal=0, mAns=-1;
    let cScore=0, cTotal=0, cAns=-1;
    let gList=[], gIdx=0, gScore=0;
    let xList=[], xIdx=0, xScore=0, xAns=-1;

    // åˆå§‹åŒ–
    function loginUser() {
        const name = document.getElementById('username-input').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥åå­—ï¼");
        currentUser = name;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('user-display').innerText = `å­¸å“¡ï¼š${currentUser}`;
        loadData();
    }

    async function loadData() {
        try {
            const res = await fetch('data.json'); // è®€å– GitHub ä¸Šçš„ data.json
            data = await res.json();
            initApp();
        } catch(e) {
            alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèª data.json å­˜åœ¨");
        }
    }

    function initApp() {
        const catSet = new Set(data.vocabulary.map(v => v.category || 'å…¶ä»–'));
        allCategories = [...catSet];
        
        initVocabView();
        initGrammarView();
        renderMultiSelect('fc-cat-list');
        renderMultiSelect('m-cat-list');
        renderMultiSelect('c-cat-list');
        
        // é å‚™æ–‡æ³•é¡Œ
        if(data.grammarQuiz) gList = data.grammarQuiz.sort(()=>Math.random()-0.5);
    }

    // --- å…±ç”¨åŠŸèƒ½ ---
    function showTab(id) {
        document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+id).classList.add('active');
        if(id==='quiz-grammar') startGrammarQuiz();
        if(id==='quiz-mixed') initMixedQuiz();
    }
    
    function renderMultiSelect(id) {
        const div = document.getElementById(id);
        div.innerHTML = `<label class="cat-label"><input type="checkbox" value="PHRASES"> ç‰‡èª</label>`;
        allCategories.forEach(c => {
            div.innerHTML += `<label class="cat-label"><input type="checkbox" value="${c}"> ${c}</label>`;
        });
        div.querySelectorAll('input').forEach(input => {
            input.parentElement.onclick = function() {
                if(input.checked) this.classList.add('checked'); else this.classList.remove('checked');
            }
        });
    }

    function getSelectedItems(id) {
        const inputs = document.querySelectorAll(`#${id} input:checked`);
        let items = [];
        inputs.forEach(input => {
            if(input.value === 'PHRASES') items = items.concat(data.phrases || []);
            else items = items.concat(data.vocabulary.filter(v => (v.category||'å…¶ä»–') === input.value));
        });
        return items;
    }

    function resetSection(id) {
        if(id==='flashcard') { document.getElementById('fc-setup').style.display='block'; document.getElementById('fc-game').style.display='none'; }
        if(id==='quiz-memory') { document.getElementById('m-setup').style.display='block'; document.getElementById('m-game').style.display='none'; }
        if(id==='quiz-cloze') { document.getElementById('c-setup').style.display='block'; document.getElementById('c-game').style.display='none'; }
        if(id==='quiz-grammar') { document.getElementById('g-setup').style.display='block'; document.getElementById('g-game').style.display='none'; }
    }

    // --- è³‡æ–™ä¸Šå‚³ Google Sheets ---
    function sendScore(type, score, total) {
        if(!GOOGLE_SCRIPT_URL.includes("script.google.com")) {
            console.warn("æœªè¨­å®š Google Script URLï¼Œç„¡æ³•ä¸Šå‚³åˆ†æ•¸");
            return;
        }
        
        const payload = {
            name: currentUser,
            type: type,
            score: score,
            total: total
        };

        // ä½¿ç”¨ no-cors æ¨¡å¼ç™¼é€ (ç„¡æ³•è®€å–å›å‚³å€¼ï¼Œä½†èƒ½æˆåŠŸç™¼é€)
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            console.log("Data sent to Google Sheets");
        }).catch(err => console.error("Upload failed", err));
    }

    // --- æ¸¬é©—çµæŸè™•ç† ---
    function endQuiz(type, score, total, resetId) {
        if(total === 0) return;
        if(confirm(`çµæŸæ¸¬é©—ï¼Ÿ\nå¾—åˆ†ï¼š${score} / ${total}\nç¢ºå®šè¦ä¸Šå‚³æˆç¸¾å—ï¼Ÿ`)) {
            sendScore(type, score, total);
            alert("æˆç¸¾å·²é€å‡ºï¼");
            resetSection(resetId);
        }
    }

    // --- å–®å­—åº« ---
    // --- å–®å­—åº« (ä¿®æ­£ç‰ˆï¼šåŠ å…¥ç‰‡èªæŒ‰éˆ•) ---
    function initVocabView() {
        const div = document.getElementById('vocab-cat-btns');
        div.innerHTML = ''; // æ¸…ç©ºæŒ‰éˆ•å€

        // 1. å…ˆåŠ å…¥ã€Œç‰‡èªã€æŒ‰éˆ•
        const phraseBtn = document.createElement('button');
        phraseBtn.className = 'v-cat-btn';
        phraseBtn.innerText = "ğŸ—£ï¸ ç‰‡èª (Phrases)";
        phraseBtn.onclick = () => renderVocabList('PHRASES', phraseBtn);
        div.appendChild(phraseBtn);

        // 2. å†åŠ å…¥å…¶ä»–å–®å­—åˆ†é¡æŒ‰éˆ•
        allCategories.forEach((c) => {
            const btn = document.createElement('button');
            btn.className = 'v-cat-btn';
            btn.innerText = c;
            btn.onclick = () => renderVocabList(c, btn);
            div.appendChild(btn);
        });

        // é è¨­é¡¯ç¤ºç¬¬ä¸€å€‹åˆ†é¡ (é€šå¸¸æ˜¯ç‰‡èªæˆ–ç¬¬ä¸€å€‹å–®å­—ä¸»é¡Œ)
        if (data.phrases && data.phrases.length > 0) {
            renderVocabList('PHRASES', phraseBtn);
        } else if (allCategories.length > 0) {
            renderVocabList(allCategories[0], div.children[1]);
        }
    }

    function renderVocabList(cat, btnElement) {
        // æ›´æ–°æŒ‰éˆ•æ¨£å¼ (Highlight ç›®å‰é¸ä¸­çš„æŒ‰éˆ•)
        document.querySelectorAll('.v-cat-btn').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');

        const div = document.getElementById('vocab-container');
        div.innerHTML = '';

        // åˆ¤æ–·æ˜¯ã€Œç‰‡èªã€é‚„æ˜¯ã€Œä¸€èˆ¬å–®å­—ã€
        let items = [];
        if (cat === 'PHRASES') {
            items = data.phrases || [];
        } else {
            items = data.vocabulary.filter(v => (v.category || 'å…¶ä»–') === cat);
        }

        // æ¸²æŸ“åˆ—è¡¨
        if (items.length === 0) {
            div.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:#888;">æš«ç„¡è³‡æ–™</div>';
            return;
        }

        items.forEach(v => {
            // ç‰‡èªå¯èƒ½æ²’æœ‰ part (è©æ€§)ï¼Œé è¨­é¡¯ç¤º phr.
            const word = v.word || v.phrase;
            const part = v.part || 'phr.';
            // åˆ¤æ–·æ˜¯å¦ç‚ºç‰‡èªæ¨£å¼ (åŠ ä¸Šç²‰ç´…è‰²é‚Šæ¡†)
            const extraClass = (cat === 'PHRASES') ? 'phrase-item' : '';
            
            div.innerHTML += `
                <div class="vocab-item ${extraClass}">
                    <div class="v-word">${word} <span class="v-part">${part}</span></div>
                    <div class="v-mean">${v.meaning}</div>
                    <div class="v-ex">${v.example}</div>
                </div>`;
        });
    }

    // --- ç¿»å¡ ---
    function initFlashcardSession() {
        activeList = getSelectedItems('fc-cat-list').sort(()=>Math.random()-0.5);
        if(activeList.length===0) return alert("è«‹å‹¾é¸ä¸»é¡Œ");
        fcIdx=0;
        document.getElementById('fc-setup').style.display='none';
        document.getElementById('fc-game').style.display='block';
        showCard();
    }
    function showCard() {
        const item = activeList[fcIdx];
        document.getElementById('fc-word').innerText = item.word || item.phrase;
        document.getElementById('fc-mean').innerText = item.meaning;
        document.getElementById('fc-ex').innerText = item.example;
        document.getElementById('fc-back').style.display='none';
    }
    function nextCard() { fcIdx = (fcIdx+1)%activeList.length; showCard(); }

    // --- æ–‡æ³•åˆ—è¡¨ ---
    function initGrammarView() {
        const div = document.getElementById('grammar-container');
        if(data.grammarRules) data.grammarRules.forEach(g => {
            div.innerHTML += `<div class="grammar-item"><div class="g-title">${g.title}</div><div>${g.content}</div></div>`;
        });
    }

    // --- å–®å­—æ¸¬é©— ---
    function initMemorySession() {
        activeList = getSelectedItems('m-cat-list');
        if(activeList.length===0) return alert("è«‹å‹¾é¸");
        mScore=0; mTotal=0;
        document.getElementById('m-setup').style.display='none';
        document.getElementById('m-game').style.display='block';
        nextMemoryQ();
    }
    function nextMemoryQ() {
        document.getElementById('m-score').innerText = mScore;
        document.getElementById('m-feedback').innerHTML = '';
        document.getElementById('m-next-btn').style.display='none';
        
        const item = activeList[Math.floor(Math.random()*activeList.length)];
        const correct = item.word || item.phrase;
        document.getElementById('m-question').innerHTML = `<span style="font-size:16px;color:#888;">è«‹å•</span><br>${item.meaning}`;
        
        let opts = [correct];
        const pool = [...data.vocabulary, ...(data.phrases||[])];
        while(opts.length<4) {
            let r = pool[Math.floor(Math.random()*pool.length)];
            let w = r.word || r.phrase;
            if(!opts.includes(w)) opts.push(w);
        }
        opts.sort(()=>Math.random()-0.5);
        mAns = opts.indexOf(correct);
        
        const div = document.getElementById('m-options');
        div.innerHTML = '';
        opts.forEach((o, i) => {
            div.innerHTML += `<div class="q-opt" onclick="checkM(this, ${i})">${o}</div>`;
        });
        mTotal++;
    }
    function checkM(btn, i) {
        document.querySelectorAll('#m-options .q-opt').forEach(b=>b.style.pointerEvents='none');
        if(i===mAns) { btn.classList.add('correct'); mScore++; document.getElementById('m-feedback').innerHTML='âœ… æ­£ç¢º'; }
        else { btn.classList.add('wrong'); document.querySelectorAll('#m-options .q-opt')[mAns].classList.add('correct'); document.getElementById('m-feedback').innerHTML='âŒ éŒ¯èª¤'; }
        document.getElementById('m-score').innerText = mScore;
        document.getElementById('m-next-btn').style.display='inline-block';
    }

    // --- å¡«ç©ºæ¸¬é©— ---
    function initClozeSession() {
        activeList = getSelectedItems('c-cat-list');
        if(activeList.length===0) return alert("è«‹å‹¾é¸");
        cScore=0; cTotal=0;
        document.getElementById('c-setup').style.display='none';
        document.getElementById('c-game').style.display='block';
        nextClozeQ();
    }
    function nextClozeQ() {
        document.getElementById('c-score').innerText = cScore;
        document.getElementById('c-feedback').innerHTML='';
        document.getElementById('c-next-btn').style.display='none';
        
        let item, sent, word, attempts=0;
        while(true) {
            item = activeList[Math.floor(Math.random()*activeList.length)];
            word = item.word || item.phrase;
            sent = item.example;
            if(sent.toLowerCase().includes(word.toLowerCase())) break;
            if(attempts++>20) break;
        }
        const regex = new RegExp(word, "gi");
        document.getElementById('c-sentence').innerText = sent.replace(regex, "______");
        document.getElementById('c-hint').innerText = `æç¤ºï¼š${item.meaning}`;
        
        let opts = [word];
        const pool = [...data.vocabulary, ...(data.phrases||[])];
        while(opts.length<4) {
            let r = pool[Math.floor(Math.random()*pool.length)];
            let w = r.word || r.phrase;
            if(!opts.includes(w)) opts.push(w);
        }
        opts.sort(()=>Math.random()-0.5);
        cAns = opts.indexOf(word);
        
        const div = document.getElementById('c-options');
        div.innerHTML = '';
        opts.forEach((o, i) => {
            div.innerHTML += `<div class="q-opt" onclick="checkC(this, ${i}, '${sent.replace(/'/g, "\\'")}')">${o}</div>`;
        });
        cTotal++;
    }
    function checkC(btn, i, full) {
        document.querySelectorAll('#c-options .q-opt').forEach(b=>b.style.pointerEvents='none');
        if(i===cAns) { btn.classList.add('correct'); cScore++; document.getElementById('c-feedback').innerHTML=`âœ… æ­£ç¢º<br>${full}`; }
        else { btn.classList.add('wrong'); document.querySelectorAll('#c-options .q-opt')[cAns].classList.add('correct'); document.getElementById('c-feedback').innerHTML=`âŒ éŒ¯èª¤<br>${full}`; }
        document.getElementById('c-score').innerText = cScore;
        document.getElementById('c-next-btn').style.display='inline-block';
    }

    // --- æ–‡æ³•æ¸¬é©— ---
    // --- æ–‡æ³•æ¸¬é©— (æ›´æ–°ç‰ˆï¼šSession æ¨¡å¼) ---
    function initGrammarSession() {
        // 1. æª¢æŸ¥æ˜¯å¦æœ‰é¡Œç›®
        if (!data.grammarQuiz || data.grammarQuiz.length === 0) {
            alert("è³‡æ–™åº«ä¸­æ²’æœ‰æ–‡æ³•é¡Œç›®ï¼");
            return;
        }

        // 2. åˆå§‹åŒ–è®Šæ•¸
        gScore = 0;
        gTotal = 0;
        gIdx = 0;
        
        // 3. éš¨æ©Ÿæ‰“äº‚é¡Œç›®é †åº
        // è¤‡è£½ä¸€ä»½æ–°çš„é™£åˆ—ä¾†æ‰“äº‚ï¼Œä»¥å…å½±éŸ¿åŸå§‹è³‡æ–™
        gList = [...data.grammarQuiz].sort(() => Math.random() - 0.5);

        // 4. åˆ‡æ›ä»‹é¢
        document.getElementById('g-setup').style.display = 'none';
        document.getElementById('g-game').style.display = 'block';
        
        // 5. é–‹å§‹ç¬¬ä¸€é¡Œ
        nextGrammarQ();
    }

    function nextGrammarQ() {
        // æª¢æŸ¥æ˜¯å¦åšå®Œæ‰€æœ‰é¡Œç›®
        if (gIdx >= gList.length) {
            alert("å¤ªå²å®³äº†ï¼ä½ å·²ç¶“åšå®Œæ‰€æœ‰ 100 é¡Œæ–‡æ³•äº†ï¼\nå°‡é‡æ–°æ´—ç‰Œé–‹å§‹ã€‚");
            gList.sort(() => Math.random() - 0.5);
            gIdx = 0;
        }

        // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
        document.getElementById('g-score').innerText = gScore;
        document.getElementById('g-total').innerText = gTotal;
        
        // é‡ç½®ä»‹é¢
        document.getElementById('g-feedback').innerHTML = '';
        document.getElementById('g-next-btn').style.display = 'none';

        // è¼‰å…¥é¡Œç›®
        const q = gList[gIdx];
        document.getElementById('g-question').innerText = q.q;

        // ç”Ÿæˆé¸é …
        const div = document.getElementById('g-options');
        div.innerHTML = '';
        q.options.forEach((o, i) => {
            div.innerHTML += `<div class="q-opt" onclick="checkG(this, ${i}, ${q.ans}, '${q.note.replace(/'/g, "\\'")}')">${o}</div>`;
        });
        
        gTotal++; // å¢åŠ ç¸½é¡Œæ•¸è¨ˆæ•¸
    }

    function checkG(btn, i, ans, note) {
        // é–å®šæ‰€æœ‰æŒ‰éˆ•
        document.querySelectorAll('#g-options .q-opt').forEach(b => b.style.pointerEvents = 'none');

        if (i === ans) {
            btn.classList.add('correct');
            gScore++;
            document.getElementById('g-feedback').innerHTML = `<span style="color:#10b981">âœ… æ­£ç¢ºï¼</span><br><span style="font-size:14px; color:#555; font-weight:normal;">è§£æï¼š${note}</span>`;
            document.getElementById('g-feedback').style.background = "#d1fae5";
        } else {
            btn.classList.add('wrong');
            // æ¨™ç¤ºæ­£ç¢ºç­”æ¡ˆ
            document.querySelectorAll('#g-options .q-opt')[ans].classList.add('correct');
            document.getElementById('g-feedback').innerHTML = `<span style="color:#ef4444">âŒ éŒ¯èª¤ï¼</span><br><span style="font-size:14px; color:#555; font-weight:normal;">è§£æï¼š${note}</span>`;
            document.getElementById('g-feedback').style.background = "#fee2e2";
        }

        // æ›´æ–°å³æ™‚åˆ†æ•¸
        document.getElementById('g-score').innerText = gScore;
        
        // æº–å‚™ä¸‹ä¸€é¡Œç´¢å¼•
        gIdx++;
        document.getElementById('g-next-btn').style.display = 'inline-block';
    }

    // --- ç¶œåˆæ¸¬é©— ---
    function initMixedQuiz() {
        xList = []; xIdx=0; xScore=0;
        document.getElementById('x-next-btn').style.display='none';
        document.getElementById('x-restart-btn').style.display='none';
        document.getElementById('x-content').style.display='block';
        document.getElementById('save-status').innerText = '';

        const vPool = [...data.vocabulary, ...(data.phrases||[])];
        const gPool = data.grammarQuiz || [];
        
        // 5 Memory
        for(let i=0; i<5; i++) {
            const item = vPool[Math.floor(Math.random()*vPool.length)];
            xList.push({type:'memory', item: item});
        }
        // 5 Cloze
        for(let i=0; i<5; i++) {
            let item, attempts=0;
            while(attempts++<20) {
                item = vPool[Math.floor(Math.random()*vPool.length)];
                if(item.example.toLowerCase().includes((item.word||item.phrase).toLowerCase())) break;
            }
            xList.push({type:'cloze', item: item});
        }
        // 10 Grammar
        gPool.sort(()=>Math.random()-0.5).slice(0,10).forEach(q => {
            xList.push({type:'grammar', q:q});
        });
        xList.sort(()=>Math.random()-0.5);
        renderMixed();
    }

    function renderMixed() {
        if(xIdx >= xList.length) {
            document.getElementById('x-content').style.display='none';
            document.getElementById('x-feedback').innerHTML = `<h2>æ¸¬é©—çµæŸ</h2><p>ç¸½åˆ†ï¼š${xScore} / 20</p>`;
            document.getElementById('x-next-btn').style.display='none';
            document.getElementById('x-restart-btn').style.display='inline-block';
            
            // è‡ªå‹•ä¸Šå‚³
            document.getElementById('save-status').innerText = "æ­£åœ¨ä¸Šå‚³æˆç¸¾...";
            sendScore('ç¶œåˆæ¨¡æ“¬è€ƒ', xScore, 20);
            return;
        }

        const q = xList[xIdx];
        document.getElementById('x-feedback').innerHTML='';
        document.getElementById('x-next-btn').style.display='none';
        const div = document.getElementById('x-options');
        div.innerHTML='';
        
        if(q.type==='memory') {
            const word = q.item.word || q.item.phrase;
            document.getElementById('x-tag').innerText = "å–®å­—è¨˜æ†¶";
            document.getElementById('x-question').innerHTML = `<span style="font-size:16px;">${q.item.meaning}</span> æ˜¯å“ªå€‹å­—ï¼Ÿ`;
            document.getElementById('x-extra').innerText = '';
            
            let opts = [word];
            const pool = [...data.vocabulary, ...(data.phrases||[])];
            while(opts.length<4) {
                let w = (pool[Math.floor(Math.random()*pool.length)]).word || (pool[Math.floor(Math.random()*pool.length)]).phrase;
                if(!opts.includes(w)) opts.push(w);
            }
            opts.sort(()=>Math.random()-0.5);
            xAns = opts.indexOf(word);
            opts.forEach((o, i) => { div.innerHTML += `<div class="q-opt" onclick="checkX(this, ${i})">${o}</div>`; });

        } else if(q.type==='cloze') {
            const word = q.item.word || q.item.phrase;
            const regex = new RegExp(word, "gi");
            document.getElementById('x-tag').innerText = "å¥å­å¡«ç©º";
            document.getElementById('x-question').innerHTML = q.item.example.replace(regex, "______");
            document.getElementById('x-extra').innerText = `æç¤º: ${q.item.meaning}`;
            
            let opts = [word];
            const pool = [...data.vocabulary, ...(data.phrases||[])];
            while(opts.length<4) {
                let w = (pool[Math.floor(Math.random()*pool.length)]).word || (pool[Math.floor(Math.random()*pool.length)]).phrase;
                if(!opts.includes(w)) opts.push(w);
            }
            opts.sort(()=>Math.random()-0.5);
            xAns = opts.indexOf(word);
            opts.forEach((o, i) => { div.innerHTML += `<div class="q-opt" onclick="checkX(this, ${i})">${o}</div>`; });

        } else if(q.type==='grammar') {
            document.getElementById('x-tag').innerText = "æ–‡æ³•";
            document.getElementById('x-question').innerText = q.q.q;
            document.getElementById('x-extra').innerText = '';
            xAns = q.q.ans;
            q.q.options.forEach((o, i) => { div.innerHTML += `<div class="q-opt" onclick="checkX(this, ${i}, '${q.q.note}')">${o}</div>`; });
        }
    }

    function checkX(btn, i, note) {
        document.querySelectorAll('#x-options .q-opt').forEach(b=>b.style.pointerEvents='none');
        if(i===xAns) { btn.classList.add('correct'); xScore++; document.getElementById('x-feedback').innerHTML='âœ… æ­£ç¢º'; }
        else { btn.classList.add('wrong'); document.querySelectorAll('#x-options .q-opt')[xAns].classList.add('correct'); document.getElementById('x-feedback').innerHTML='âŒ éŒ¯èª¤'; }
        if(note) document.getElementById('x-feedback').innerHTML += `<br><span style="font-size:14px;color:#555">${note}</span>`;
        document.getElementById('x-next-btn').style.display='inline-block';
    }
    function nextMixedQ() { xIdx++; renderMixed(); }

</script>

</body>
</html>